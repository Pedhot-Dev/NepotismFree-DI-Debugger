name: CI

permissions:
  contents: write

on:
  push:
    branches: [ "main", "master" ]
    tags:
      - "v*"
  pull_request:
    branches: [ "main", "master" ]

jobs:
  smoke-test:
    name: Smoke Test (PHP ${{ matrix.php-versions }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        php-versions: ['8.2']

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-versions }}
          tools: composer:v2
          coverage: none

      - name: Install Composer Dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: Run CLI Smoke Tests
        run: |
          echo "Testing CLI boot..."
          php bin/di list

          echo "Testing Graph generation..."
          php bin/di di:graph -b tests/fixtures/bootstrap.php

      - name: Run Unit & Contract Tests
        run: vendor/bin/phpunit

  release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: [smoke-test]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2

      - name: Install Composer Dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: Generate Validation JSON
        id: validate
        run: |
          set +e
          php bin/di di:validate --format=json -b tests/fixtures/diagnostic_bootstrap.php > validation.json
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: validation.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enforce Validation Result
        run: |
          if [ "${{ steps.validate.outputs.exit_code }}" != "0" ]; then
            echo "❌ Dependency validation failed. Failing release job."
            exit 1
          else
            echo "✅ Dependency validation passed."
          fi
