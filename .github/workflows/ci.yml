name: CI

permissions:
  contents: write

on:
  push:
    branches: [ "main", "master" ]
    tags:
      - "v*"
  pull_request:
    branches: [ "main", "master" ]

jobs:
  smoke-test:
    name: Smoke Test (PHP ${{ matrix.php-versions }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        php-versions: ['8.2']

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-versions }}
          tools: composer:v2
          coverage: none

      - name: Install Composer Dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: Run CLI Smoke Tests
        run: |
          echo "Testing CLI boot..."
          php bin/di list

          echo "Testing Graph generation..."
          php bin/di di:graph -b tests/fixtures/bootstrap.php

      - name: Run Unit & Contract Tests
        run: vendor/bin/phpunit

  release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: [smoke-test]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2

      - name: Install Composer Dependencies
        run: composer install --prefer-dist --no-interaction --no-progress

      # ---------- VALID GRAPH ----------
      - name: Generate VALID dependency report
        run: |
          php bin/di di:validate \
            --format=json \
            -b tests/fixtures/bootstrap.php \
            > validation-valid.json

      # ---------- INVALID GRAPH (EXPECTED FAILURE) ----------
      - name: Generate INVALID dependency report (diagnostic)
        run: |
          set +e
          php bin/di di:validate \
            --format=json \
            -b tests/fixtures/diagnostic_bootstrap.php \
            > validation-invalid.json
          echo "Expected exit code (non-zero) ignored for diagnostic graph."

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            validation-valid.json
            validation-invalid.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
